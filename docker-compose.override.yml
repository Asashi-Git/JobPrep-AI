services:
  api:
    build:
      context: ./api
      dockerfile: Dockerfile
      target: development
    restart: no
    environment:
      - NODE_ENV=development
      - PORT=3000
      - DB_HOST=mariadb
      - DB_PORT=3306
      - DB_USER_FILE=/run/secrets/db_user
      - DB_PASSWORD_FILE=/run/secrets/db_password
      - DB_NAME_FILE=/run/secrets/db_name
      - JWT_SECRET_FILE=/run/secrets/jwt_secret
      - AI_API_KEY_FILE=/run/secrets/api_key
    ports:
      - "3000:3000"
    volumes:
      - ./api:/app
      - api_node_modules:/app/node_modules
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s

  app:
    build:
      context: ./app
      dockerfile: Dockerfile
      target: development
    restart: no
    environment:
      - VITE_API_URL=http://localhost:3000
    ports:
      - "5000:5000"
    volumes:
      - ./app:/app
      - app_node_modules:/app/node_modules
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s

  mariadb:
    ports:
      - "3306:3306"

  # cypress:
  #   build:
  #     context: ./cypress
  #     dockerfile: Dockerfile
  #   container_name: jobprep_cypress
  #   environment:
  #     - CYPRESS_baseUrl=http://app:5000
  #     - CYPRESS_apiUrl=http://api:3000/api
  #   working_dir: /app
  #   volumes:
  #     - ./cypress/e2e:/app/cypress/e2e
  #     - ./cypress/fixtures:/app/cypress/fixtures
  #     - ./cypress/support:/app/cypress/support
  #     - ./cypress/cypress.config.js:/app/cypress.config.js
  #     - ./cypress/screenshots:/app/cypress/screenshots
  #     - ./cypress/videos:/app/cypress/videos
  #   depends_on:
  #     app:
  #       condition: service_healthy
  #     api:
  #       condition: service_healthy
  #   networks:
  #     - jobprep_public_network
  #   profiles:
  #     - testing